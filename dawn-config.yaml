infra_flavor_id: 6b56d6e9-5397-4543-87fb-e0c0b6d47961
infra_network_id: "{{ lookup('pipe', 'openstack network show test -f value -c id') }}"

azimuth_capi_operator_capi_helm_chart_name: openstack-cluster
azimuth_capi_operator_capi_helm_chart_repo: https://azimuth-cloud.github.io/capi-helm-charts
azimuth_capi_operator_capi_helm_chart_version: 0.14.2-dev.0.intel-helm.27
azimuth_capi_operator_chart_version: 0.8.7-dev.0.pvctest.28

flux_enabled: true
azimuth_capi_operator_app_templates_jupyterhub_intel_enabled: true

azimuth_capi_operator_release_overrides:
  config:
    capiHelm:
      flavorSpecificNodeGroupOverrides:
        '*.pvc.*':
          kubeadmConfigSpec:
            preKubeadmCommands:
              - |
                # Adapted from https://dgpu-docs.intel.com/driver/installation.html#ubuntu
                sudo apt update
                sudo apt install -y gpg-agent wget
                . /etc/os-release
                if [[ ! " jammy " =~ " ${VERSION_CODENAME} " ]]; then
                    echo "Ubuntu version ${VERSION_CODENAME} not supported"
                else
                    wget -qO - https://repositories.intel.com/gpu/intel-graphics.key | \
                    sudo gpg --yes --dearmor --output /usr/share/keyrings/intel-graphics.gpg
                    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/intel-graphics.gpg] https://repositories.intel.com/gpu/ubuntu ${VERSION_CODENAME}/lts/2350 unified" | \
                    sudo tee /etc/apt/sources.list.d/intel-gpu-${VERSION_CODENAME}.list
                    sudo apt update
                fi
                sudo apt install -y \
                    linux-headers-$(uname -r) \
                    linux-modules-extra-$(uname -r) \
                    flex bison \
                    intel-fw-gpu intel-i915-dkms xpu-smi
                # Avoids reboot
                modprobe i915
            files:
            - path: /etc/kubernetes/patches/kubeletconfiguration0+strategic.json
              owner: "root:root"
              permissions: "0644"
              content: |
                {
                  "apiVersion": "kubelet.config.k8s.io/v1beta1",
                  "kind": "KubeletConfiguration",
                  "reservedSystemCPUs": "0-3",
                  "cpuManagerPolicy": "static",
                  "cpuManagerPolicyOptions":
                  {
                      "full-pcpus-only": "true",
                  },
                  "topologyManagerPolicy": "restricted",
                  "memoryManagerPolicy": "Static",
                  "reservedMemory": [
                      {
                        "numaNode": 0,
                        "limits": {
                          "memory": "1Gi",
                        }
                      }
                    ],
                  "evictionHard": {
                    "memory.available": "1Gi",
                  },
                }
            joinConfiguration:
              patches:
                directory: /etc/kubernetes/patches
              nodeRegistration:
                taints:
                - effect: NoSchedule
                  key: gpu.intel.com/i915
                
azimuth_capi_operator_cluster_templates_extra:
  intel-pvc-cluster:
    annotations:
      acl.azimuth.stackhpc.com/allow-list: ''
      acl.azimuth.stackhpc.com/allow-regex: ''
      acl.azimuth.stackhpc.com/deny-list: ''
      acl.azimuth.stackhpc.com/deny-regex: ''
    spec:
      label: intel-pvc-cluster
      description: HA Kubernetes v1.31.5 with Intel XPU plugin
      values:
        kubernetesVersion: 1.31.5
        machineImageId: "f998a271-de4f-40ca-b70d-951d39dc56fe"

        clusterNetworking:
          externalNetworkId: "57add367-d205-4030-a929-d75617a7c63e"
          internalNetwork:
            networkFilter:
              id: ed05039e-3bc1-4e24-844b-89387eb297d2
              name: test
        
        controlPlane:
          kubeadmConfigSpec:
            clusterConfiguration:
              apiServer:
                extraArgs:
                  enable-admission-plugins: ExtendedResourceToleration
                
        addons:
          cni:
            type: cilium
            cilium:
              release:
                values:
                  hubble:
                    relay:
                      enabled: true
                    ui:
                      enabled: true
          monitoring:
            enabled: true
          csi:
            cephfs:
              enabled: true
          openstack:
            enabled: true
            # turn off cinder, as it doesn't work with baremetal
            # csiCinder:
            #   enabled: false
            # csiManila:
            #   enabled: true
            #   defaultStorageClass:
            #     isClusterDefault: true
            #     parameters:
            #       type: ceph01_cephfs
          nodeFeatureDiscovery:
            enabled: true
          nvidiaGPUOperator:
            enabled: false
          mellanoxNetworkOperator:
            enabled: true
            release:
              values:
                # TODO work through
                # https://docs.nvidia.com/networking/display/kubernetes2410/getting+started+with+kubernetes#src-2494425587_GettingStartedwithKubernetes-NetworkOperatorDeploymentwithanSR-IOVInfiniBandNetworkwithPKeyManagement
                # turn off the shared plugin
                rdmaSharedDevicePlugin:
                  deploy: false
                # we try to use SRIOV with host devs
                sriovDevicePlugin:
                  deploy: true
                ibKubernetes:
                  deploy: true
                secondaryNetwork:
                  deploy: true
          ingress:
            enabled: true
            nginx:
              release:
                values:
                  controller:
                    extraArgs:
                      enable-ssl-passthrough: "true"
          intelDevicePlugin:
            enabled: true
