azimuth_authentication_type: oidc
ingress_tls_enabled: true
azimuth_capi_operator_chart_version: 0.8.7-dev.0.oidc-flavours-test.19
azimuth_identity_operator_chart_version: 0.8.6-dev.0.feat-additional-crds.6

azimuth_capi_operator_capi_helm_chart_name: openstack-cluster
azimuth_capi_operator_capi_helm_chart_repo: https://azimuth-cloud.github.io/capi-helm-charts
azimuth_capi_operator_capi_helm_chart_version: 0.14.2-dev.0.intel-helm.11
azimuth_capi_operator_release_overrides:
  config:
    identity:
      oidcEnabled: true
      defaultUserNamespaceRole:
        namespaces:
        - prod
        - dev
        - staging
      defaultUserClusterRole:
        rules:
        - apiGroups:
          - argoproj.io
          resources:
          - cronworkflows
          - cronworkflows/finalizers
          - clusterworkflowtemplates
          - clusterworkflowtemplates/finalizers
          verbs:
          - create
          - delete
          - deletecollection
          - get
          - list
          - patch
          - update
          - watch
        - apiGroups: ["apiextensions.k8s.io"]
          resources: ["customresourcedefinitions"]
          verbs: ["get","list","watch","create"]
    capiHelm:
      flavorSpecificNodeGroupOverrides:
        'bm.*':
          kubeadmConfigSpec:
            files:
            - path: /etc/kubernetes/patches/kubeletconfiguration0+strategic.json
              owner: "root:root"
              permissions: "0644"
              content: |
                {
                  "apiVersion": "kubelet.config.k8s.io/v1beta1",
                  "kind": "KubeletConfiguration",
                  "reservedSystemCPUs": "0-3",
                  "cpuManagerPolicy": "static",
                  "cpuManagerPolicyOptions":
                  {
                      "full-pcpus-only": "true",
                  },
                  "topologyManagerPolicy": "restricted",
                  "memoryManagerPolicy": "Static",
                  "reservedMemory": [
                      {
                        "numaNode": 0,
                        "limits": {
                          "memory": "1Gi",
                        }
                      }
                    ],
                  "evictionHard": {
                    "memory.available": "1Gi",
                  },
                }
            joinConfiguration:
              patches:
                directory: /etc/kubernetes/patches
              nodeRegistration:
                taints:
                - effect: NoSchedule
                  key: gpu.intel.com/i915
                
azimuth_capi_operator_cluster_templates_extra:
  intel-gpu-baremetal:
    annotations:
      acl.azimuth.stackhpc.com/allow-list: ''
      acl.azimuth.stackhpc.com/allow-regex: ''
      acl.azimuth.stackhpc.com/deny-list: ''
      acl.azimuth.stackhpc.com/deny-regex: ''
    spec:
      label: intel-gpu-baremetal
      description: HA Kubernetes v1.31.4 with OIDC and Intel XPU plugin
      values:
        kubernetesVersion: 1.31.4
        machineImageId: "6ed3da4b-3b65-4d44-959f-f35956db1c78"

        clusterNetworking:
          externalNetworkId: "4d00778c-303f-49b2-b624-e3004262312d"
          internalNetwork:
            networkFilter:
              id: 5ee983c5-12b2-4bf4-83c6-e7cb394801e0
              name: bm-test-net
        
        controlPlane:
          kubeadmConfigSpec:
            clusterConfiguration:
              apiServer:
                extraArgs:
                  enable-admission-plugins: ExtendedResourceToleration
                
        addons:
          cni:
            type: cilium
            cilium:
              release:
                values:
                  hubble:
                    relay:
                      enabled: true
                    ui:
                      enabled: true
          monitoring:
            enabled: true
          csi:
            cephfs:
              enabled: true
          openstack:
            enabled: true
            # turn off cinder, as it doesn't work with baremetal
            csiCinder:
              enabled: false
            csiManila:
              enabled: true
              defaultStorageClass:
                isClusterDefault: true
                parameters:
                  type: ceph01_cephfs
          nodeFeatureDiscovery:
            enabled: true
          nvidiaGPUOperator:
            enabled: false
          mellanoxNetworkOperator:
            enabled: true
            release:
              values:
                # TODO work through
                # https://docs.nvidia.com/networking/display/kubernetes2410/getting+started+with+kubernetes#src-2494425587_GettingStartedwithKubernetes-NetworkOperatorDeploymentwithanSR-IOVInfiniBandNetworkwithPKeyManagement
                # turn off the shared plugin
                rdmaSharedDevicePlugin:
                  deploy: false
                # we try to use SRIOV with host devs
                sriovDevicePlugin:
                  deploy: true
                ibKubernetes:
                  deploy: true
                secondaryNetwork:
                  deploy: true
          ingress:
            enabled: true
            nginx:
              release:
                values:
                  controller:
                    extraArgs:
                      enable-ssl-passthrough: "true"
          intelDevicePlugin:
            enabled: true
            gpuPlugin:
              release:
                values:
                  tolerations:
                  - key: gpu.intel.com/i915
                    operator: "Exists"
                    effect: "NoSchedule"
            xpuManagerMonitoring:
              enabled: true
          restrictedAdmission:
            enabled: true
            chart:
              repo: https://azimuth-cloud.github.io/restricted-pss-vaps-helm/
            release:
              values:
                defaultBindingNamespaceSelector:
                  matchExpressions:
                  - key: kubernetes.io/metadata.name
                    operator: In
                    values:
                    - prod
                    - dev
                    - staging
                allowedCapabilities:
                - NET_BIND_SERVICE
                - IPC_LOCK
          custom:
            oidc-user-prod-namespace:
              kind: Manifests
              spec:
                namespace: prod
                manifests:
                  prod-namespace.yaml: |
                    apiVersion: v1
                    kind: Namespace
                    metadata:
                      name: prod
            oidc-user-dev-namespace:
              kind: Manifests
              spec:
                namespace: dev
                manifests:
                  dev-namespace.yaml: |
                    apiVersion: v1
                    kind: Namespace
                    metadata:
                      name: dev
            oidc-user-staging-namespace:
              kind: Manifests
              spec:
                namespace: staging
                manifests:
                  staging-namespace.yaml: |
                    apiVersion: v1
                    kind: Namespace
                    metadata:
                      name: staging
